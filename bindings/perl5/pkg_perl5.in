# -*-makefile-*-

API_XML = ../doc/docbook/src/api.xml
PLPLOT_H = plplot/plplot.h
PLCONFIG_H = plplot/plConfig.h
PLPLOT_PM = PLplot.pm

TMP_DIR = ../../tmp

# These must stay in this order (they are arguments for api2bind.pl)
IN_FILES = \
  PLplot.i.in \
  Makefile.PL.in \
  $(PLPLOT_PM)-add.in

DEMOS = \
  x01.pl \
  x02.pl \
  x09.pl

SCRIPTS = \
  api2bind.pl \
  addpm.pl

all: PLplot.pm PLplot.so

ln-tmp:
	for i in $(IN_FILES) $(SCRIPTS) pkg_perl5.in $(DEMOS) ; do \
	  ln -sf ../bindings/perl5/$$i $(TMP_DIR)/$$i ; \
	done

interface: interface-stamp
interface-stamp: api2bind.pl $(API_XML) $(PLPLOT_H) $(PLCONFIG_H) $(IN_FILES)
	./api2bind.pl $(API_XML) $(IN_FILES:.in=)
	touch interface-stamp

Makefile.PL PLplot.i PLplot.pm-add: interface

swig-run: swig-run-stamp
swig-run-stamp: PLplot.i PLplot.pm-add
	swig -perl5 PLplot.i 
	cat PLplot.pm PLplot.pm-add > PLplot.pm-tmp
	mv PLplot.pm-tmp PLplot.pm 
	touch swig-run-stamp

PLplot_wrap.c PLplot.pm: swig-run

Makeperl: Makefile.PL
	perl $<

PLplot.so: PLplot_wrap.c Makeperl 
	$(MAKE) -f Makeperl

clean:
	-$(MAKE) -f Makeperl clean
	rm -f Makefile.PL PLplot.i PLplot*.pm PLplot.pm-tmp PLplot.pm-add \
	  Makeperl PLplot_wrap.* *-stamp

.PHONY: all ln-tmp interface swig-run clean 