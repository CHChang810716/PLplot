# -*-makefile-*----------------------------------------------------------------
# $Id$
#
# Make assignments for PLplot/Python support.
#
# Python supports dynamically loaded libraries, and we use the canonical
# method recommended at http://www.python.org/doc/current/ext/building-on-unix.html
# to build these libraries.  It is claimed this method will work for all
# Unix systems.  
#
# For our implementation of this method, at configuration time we symlink all
# required files but Setup.in into tmp/python_dynamic, and at build time
# and install time (where we link differently) we create the required 
# two-line Setup.in in the same directory and build according to the
# canonical rules.
# Note we build in a separate special directory because the build process
# creates a Makefile which would nameclash with other directories that have a
# Makefile in them (e.g., tmp).
# -----------------------------------------------------------------------------

SO		= @SO@
PYTHON_EXE	= plmodule$(SO)
PYQT_PYTHON_EXE	= pyqt_plmodule$(SO)
PYTHON_INC_DIR	= @PYTHON_INC_DIR@
PYTHON_NUM_DIR	= @PYTHON_NUM_DIR@
PYTHON_MOD_DIR	= @PYTHON_MOD_DIR@
PYTHON_MACH_DIR	= @PYTHON_MACH_DIR@
PYTHON_CFG_DIR	= @PYTHON_CFG_DIR@
#These libraries do not exist on Linux systems (at least for python-1.5) so
#must comment out.  If required on other systems, must do something fancy.
#PYTHON_LIBS	= -L$(PYTHON_CFG_DIR) -lModules -lObjects -lParser -lPython
PYTHON_LIBS=
PYTHON_DIR	= @PYTHON_DIR@
LDSHARED	= @LDSHARED@

PYTHON_DEMOS	= pytkdemo *.py

# Variables for use in "make" and "make install".

INSTALL_PYTHON	= install_python

PYTHON_INSTDIR = $(PREFIX)/@PYTHON_INSTDIR@

install_python: python_dynamic/plmodule.c \
	python_dynamic/pyqt_plmodule.c
	@cd python_dynamic ; make -s -f Makefile.pre.in distclean
	@echo '*shared*' > python_dynamic/Setup.in
	@echo 'pl plmodule.c -I$(INCLUDE_DIR)/.. -I$(PYTHON_INC_DIR) -I$(PYTHON_NUM_DIR) $(LIB_INSTALL) $(LDC_LIBS) $(INSTALL_RPATH)' >> python_dynamic/Setup.in
	@cd python_dynamic ; make -s -f Makefile.pre.in boot ; make -s ; \
	 $(MV) $(PYTHON_EXE) ..
	@cd python_dynamic ; make -s -f Makefile.pre.in distclean
	@echo '*shared*' > python_dynamic/Setup.in
	@echo 'pyqt_pl pyqt_plmodule.c -I$(INCLUDE_DIR)/.. -I$(PYTHON_INC_DIR) -I$(PYTHON_NUM_DIR) $(LIB_INSTALL) $(LDC_LIBS) $(INSTALL_RPATH)' >> python_dynamic/Setup.in
	@cd python_dynamic ; make -s -f Makefile.pre.in boot ; make -s ; \
	 $(MV) $(PYQT_PYTHON_EXE) ..
	@-if test ! -d $(PYTHON_INSTDIR); then mkdir -p $(PYTHON_INSTDIR); fi
	@-$(CP) $(PYTHON_EXE) $(PYTHON_INSTDIR)
	@-$(CP) $(PYQT_PYTHON_EXE) $(PYTHON_INSTDIR)
	@-if test "$(PYTHON_DIR)" != "$(PYTHON_MACH_DIR)"; then \
	  echo "PLplot Python module installation warning:" ; \
	  echo "" ; \
	  echo "The install location $(PYTHON_DIR) for"  ; \
	  echo "plmodule.so is not the same as the expected Python location for"  ; \
	  echo "dynamic libraries $(PYTHON_MACH_DIR)"  ; \
	  echo "so you must set the environment variable PYTHONDIR to the install"  ; \
	  echo "location in order to make the Python PLplot module(s) work." ; \
	fi
	@-if test ! -d $(DEMOS_DIR)/python; then mkdir -p $(DEMOS_DIR)/python; fi
	@-cd $(top_srcdir)/examples/python ; \
	$(CP) README.python $(DEMOS_DIR)/python ; \
	for i in $(PYTHON_DEMOS) ; do \
	  sed 's:@MODULE_DIR@:$(PYTHON_DIR):' < $$i > $(DEMOS_DIR)/python/$$i ; \
	  chmod a+rx $(DEMOS_DIR)/python/$$i ; \
	done
