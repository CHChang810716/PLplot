# File: Makefile.in
# Description: Makefile template for PLplot-DocBook project
# Author: Rafael Laboissière <rafael@icp.inpg.fr>
# Created on: Thu May 20 11:14:38 CEST 1999
# Last modified on: Wed Nov 15 11:57:53 CET 2000
# $Id$

#temporary kludge to be replaced by a real version number system
VERSION=0.0.1

#This is the directory where the results are installed  Be careful with
#the choice here.  This directory is completely destroyed by the uninstall
#target
HTML_DESTDIR = ../html

STYLESHEET_HTML = plplotdoc-html.dsl
STYLESHEET_PRINT = plplotdoc-print.dsl

#the combination of these 3 file lists gives everything in the cvs.  This is
#all that is required to build docbook results from source.  These 3 lists
#need to be maintained in parallel with deleting or adding to the cvs.

SGML_SOURCES = \
	advanced.sgml   api.sgml     cplus.sgml \
	drivers.sgml  gui.sgml  intro.sgml \
	perl.sgml plplotdoc.sgml  python.sgml \
	scheme.sgml  simple.sgml   tcl.sgml  wish.sgml \
	inline-html.ent  inline-print.ent

OTHER_SOURCES = \
	CHANGES Makefile.in README configure configure.in \
	eps2jpeg.pl.in included-html-files.pl inline-greek.pl.in \
	jadetex.cfg over-under.tex parse-api.pl parse.pl tex2eps.pl.in \
	$(STYLESHEET_HTML).in $(STYLESHEET_PRINT)

CONFDIR_SOURCES = \
	conf/test.dsl.in  conf/test.sgml.in


PLPLOTDOC_HTML=plplotdoc-html
PLPLOTDOC_SRC=plplotdoc-src
JADE = @JADE@
JADETEX = @JADETEX@
PERL = @PERL@
SGML_CATALOGS=@SGML_CATALOGS@
HTML_EXT=@HTML_EXT@

BASE = plplotdoc
MAIN_HTML = book1.$(HTML_EXT)

MAX_TEX_RECURSION=4

all: src_tar html_tar ps

src_tar: $(PLPLOTDOC_SRC)-$(VERSION).tar.gz
$(PLPLOTDOC_SRC)-$(VERSION).tar.gz: ../README.developers $(SGML_SOURCES) \
	$(OTHER_SOURCES) $(CONFDIR_SOURCES)
	mkdir -p $(PLPLOTDOC_SRC)-$(VERSION)/conf
	cp -p ../README.developers $(SGML_SOURCES) $(OTHER_SOURCES) $(PLPLOTDOC_SRC)-$(VERSION)
	cp -p $(CONFDIR_SOURCES) $(PLPLOTDOC_SRC)-$(VERSION)/conf
	tar cfz $(PLPLOTDOC_SRC)-$(VERSION).tar.gz $(PLPLOTDOC_SRC)-$(VERSION)

#(AWI discussion: as our documentation gets more complicated, book1.html may
#not have all cross-references to *.html files although perhaps this is the
#docbook standard, I am not sure.  How about doing a simple
#shell ls *.html instead of using included-html-files.pl, or better yet, use
#meaningful names rather than numerical ones and keep a maintained file
#list earlier in this Makefile?)

html_tar: $(PLPLOTDOC_HTML)-$(VERSION).tar.gz
$(PLPLOTDOC_HTML)-$(VERSION).tar.gz: included-html-files.pl $(MAIN_HTML) \
	   inline.manifest over-under.jpeg
	mkdir -p $(PLPLOTDOC_HTML)-$(VERSION)
	cp -p `$(PERL) included-html-files.pl < $(MAIN_HTML)` $(MAIN_HTML) \
	   `cat inline.manifest` \
           over-under.jpeg $(PLPLOTDOC_HTML)-$(VERSION) 
	tar cfz $(PLPLOTDOC_HTML)-$(VERSION).tar.gz \
            $(PLPLOTDOC_HTML)-$(VERSION)

#inline.manifest is a list of all the in-line jpeg images made by inline-greek.pl
#These same jpeg images are referred to by inline-html.ent (see below)
inline.manifest: inline-greek.pl
	$(PERL) inline-greek.pl

over-under.eps: over-under.tex tex2eps.pl
	$(PERL) tex2eps.pl -s `cat over-under.tex` -x 1000 -o over-under.eps

over-under-big.eps: over-under.tex tex2eps.pl
	$(PERL) tex2eps.pl -s `cat over-under.tex` -x 5000 \
          -o over-under-big.eps

over-under.jpeg: over-under-big.eps eps2jpeg.pl
	$(PERL) eps2jpeg.pl -g 35% -i over-under-big.eps -o over-under.jpeg

#This dependency is incomplete.  $(MAIN_HTML) should be replaced by a
#complete list of all html files produced by this stanza of commands, but I
#have decided to wait until we specify meaningful file names (api.html, etc.)
#to replace the current numerical file names.

html: $(MAIN_HTML)
$(MAIN_HTML): $(SGML_SOURCES) $(STYLESHEET_HTML) inline-html.ent \
            over-under.jpeg inline.manifest
	ln -fs inline-html.ent inline.ent
	$(JADE) $(SGML_CATALOGS) -d $(STYLESHEET_HTML) -t sgml $(BASE).sgml


ps: $(BASE).ps.gz
$(BASE).ps.gz: $(BASE).dvi over-under.eps
	dvips -f $(BASE).dvi | gzip -c > $(BASE).ps.gz

$(BASE).dvi: $(BASE).tex over-under.eps
	# Trick from Adam Di Carlo <adam@onshore.com> to recurse jadetex 
	# "just enough".
	-cp -pf prior.aux pprior.aux
	-cp -pf $(shell basename $< .tex).aux prior.aux
	$(JADETEX) $< 
	if ! cmp $(shell basename $< .tex).aux prior.aux && \
	   ! cmp $(shell basename $< .tex).aux pprior.aux && \
	   expr $(MAKELEVEL) '<' $(MAX_TEX_RECURSION); then \
		rm -f $@ ; \
		$(MAKE) $@ ; \
	fi
	rm -f prior.aux pprior.aux

$(BASE).tex: $(SGML_SOURCES) $(STYLESHEET_PRINT) inline-print.ent
	ln -fs inline-print.ent inline.ent
	$(JADE) $(SGML_CATALOGS) -d $(STYLESHEET_PRINT) -t tex $(BASE).sgml



#The hard links below are so that browser retrievals get the full archive
#and not just the symbolic link to it. (This behaviour seems strange to AWI
#but it happened for at least the konqueror browser.)

install: install-stamp
install-stamp: all
	mkdir -p $(HTML_DESTDIR)
	rm -rf $(HTML_DESTDIR)/*
	cp -p $(PLPLOTDOC_SRC)-$(VERSION).tar.gz $(HTML_DESTDIR)
	ln $(PLPLOTDOC_SRC)-$(VERSION).tar.gz $(HTML_DESTDIR)/$(PLPLOTDOC_SRC).tar.gz
	cp -p $(PLPLOTDOC_HTML)-$(VERSION).tar.gz $(HTML_DESTDIR)
	ln $(PLPLOTDOC_HTML)-$(VERSION).tar.gz $(HTML_DESTDIR)/$(PLPLOTDOC_HTML).tar.gz
	cp -p $(PLPLOTDOC_HTML)-$(VERSION)/* $(HTML_DESTDIR)
	cp -p $(BASE).dvi $(BASE).ps.gz $(HTML_DESTDIR)
	touch install-stamp

uninstall: 
	rm -rf $(HTML_DESTDIR) install-stamp

clean:
	rm -f *.$(HTML_EXT) $(BASE).{tex,dvi,aux,log,ps.gz} \
	      TMP* inline.ent *.eps *.jpeg inline.manifest install-stamp \
	      conftest.* config.* *~ \
	      $(PLPLOTDOC_HTML)-$(VERSION).tar.gz \
	      $(PLPLOTDOC_SRC)-$(VERSION).tar.gz
	      
	rm -rf $(PLPLOTDOC_HTML)-$(VERSION)
	rm -rf $(PLPLOTDOC_SRC)-$(VERSION)

distclean: clean
	rm -f Makefile eps2jpeg.pl inline-greek.pl  tex2eps.pl @JADELOG@

.PHONY: all html ps src_tar html_tar install uninstall clean distclean
